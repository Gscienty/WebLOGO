<html>
    <head>
        <title>LOGO Language Editor</title>
        <meta charset="utf-8" />
        <link href="src\bootstrap.min.css" type="text/css" rel="stylesheet">
    </head>
    <body>
        <div class="row">
            <div class="col-xs-10 col-xs-offset-1">
                <canvas id="draw-panel" width="400" height="300" style="margin:auto;"></canvas>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-8 col-xs-offset-2">
                <div id="shell-panel" style="overflow-y: scroll; height:450px; background:#003333 
; color:#00FFCC;padding: 10px;font-family:'Times New Roman';letter-spacing:2px">
                    <div id='output-view'>
                        Welcome to LOGO Language Editor.<br/>
                    </div>
                    <div class="shell-view">
                        <span class="prompt">$</span>&nbsp;<span id="shell-input"></span><span id="cursor">_</span>
                    </div>
                </div>
            </div>
        </div>
        <script src="src\jquery-1.11.2.min.js"></script>

        <script src="src\turtle.base.js"></script>
        <script src="src\command.base.js"></script>
        <script src="src\command.math.js"></script>
        <script src="src\command.grammer_tree.js"></script>

        <script>
            commands.extend({
                name : 'clear',
                test : function(a) { return a.match(/^clear$/); },
                method : function() { $('#output-view').html(''); return { name : 'null' }; },
                param : 0
            });

            commands.extend({
                name : 'flush',
                test : function(a) { return a.match(/^flush$/); },
                method : function() { window.location.reload(); return { name : 'null' }; },
                param : 0
            });

            setInterval(function(){
                if($('#cursor').html() === '_'){
                    $('#cursor').html(' ');
                }
                else{
                    $('#cursor').html('_');
                }
            }, 500);

            document.onkeydown = function(e){
                e.preventDefault();
                if(e.which === 32){
                    $('#shell-input').html($('#shell-input').html() + '&nbsp;');
                }
                else if(e.which === 8){
                    if(/&nbsp;$/.test($('#shell-input').html())){
                        $('#shell-input').html($('#shell-input').html().substr(0, $('#shell-input').html().length - 6));
                    }
                    else{
                        $('#shell-input').html($('#shell-input').html().substr(0, $('#shell-input').html().length - 1));
                    }
                }
                else if(e.which === 13){
                    $('#output-view').html($('#output-view').html() + '<span class="prompt">$</span>&nbsp<span>' + $('#shell-input').html() + '</span><br/>');

                    var cmd = $('#shell-input').html();
                    $('#shell-input').html('');
                    while(cmd.indexOf('&nbsp;') != -1){
                        cmd = cmd.replace('&nbsp;', ' ');
                    };

                    var pre_cmd = '';
                    var has_spacing = false;
                    for(var i = 0; i < cmd.length; i++){
                        if(cmd[i] === ' ' && has_spacing === true){ continue; }
                        else if (cmd[i] === ' ') { has_spacing = true; }
                        else { has_spacing = false; }
                        pre_cmd = pre_cmd + cmd[i];
                    };

                    var grammer_tree = build_grammer_tree(pre_cmd)[0];
                    console.log(grammer_tree);
                    var result = execute_grammer_tree(grammer_tree).content;
                    console.log(result);
                    if(result != undefined){
                        result = ' ' + result;
                        while(result.indexOf(' ') != -1){
                            result = result.replace(' ', '&nbsp;');
                        };
                        document.getElementById('output-view').innerHTML += '<span>' + result + '</span><br/>';
                    }

                    document.getElementById('shell-panel').scrollTop = document.getElementById('shell-panel').scrollHeight;
                }
                else{
                    $('#shell-input').html($('#shell-input').html() + e.char);
                }
            }
        </script>
    </body>
</html>